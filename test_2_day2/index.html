<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Experiment Day 2</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">
</head>

<body></body>
<script>
    const jsPsych = initJsPsych();
    let timeline = [];
    let task1_exposed_nums = [];

    function getCountdown() {
        return [3, 2, 1].map(n => ({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<h1>${n}</h1>`,
            choices: "NO_KEYS",
            trial_duration: 1000
        }));
    }

    // 1. ID入力
    timeline.push({
        type: jsPsychSurveyText,
        questions: [{ prompt: "先日発行された参加者IDを入力してください。", name: 'id', required: true }],
        on_finish: function (data) {
            jsPsych.data.addProperties({ subject_id: data.response.id });
        }
    });

    // 2. データ照合（失敗したら停止）
    // --- Day 2の「2. データ照合」部分をこれに差し替え ---
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "データを照合しています。少々お待ちください...",
        choices: "NO_KEYS",
        on_load: async function () {
            const subject_id = jsPsych.data.get().last(1).values()[0].subject_id;
            // Day 1のデータが保存されているGASのURL
            const task1_url = "https://script.google.com/macros/s/AKfycbxYgoaPPcYSgk4DbrdUlSaFO438JnQ2Cev3Olg1MDvkG_NTQLpcXfxWhNBXZb_WKQ-qQg/exec";

            try {
                // URLにIDをくっつけて送る。リダイレクトを許可する設定を追加。
                const response = await fetch(`${task1_url}?id=${subject_id}`, {
                    method: "GET",
                    mode: "cors", // データを「受け取る」ときはcorsを使う
                    redirect: "follow"
                });
                const resData = await response.json();

                if (resData.exposed_nums && resData.exposed_nums.length > 0) {
                    task1_exposed_nums = resData.exposed_nums;
                    jsPsych.finishTrial(); // 成功したら次の画面へ
                } else {
                    throw new Error("IDに対応する先日のデータが見つかりません。");
                }
            } catch (e) {
                console.error(e);
                document.body.innerHTML = `<div style="text-align:center; margin-top:50px; color:red;"><h2>エラー</h2><p>データの取得に失敗しました：${e.message}</p></div>`;
            }
        }
    });
    // --- Task 2 説明 ---
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h3>先日に引き続き、ご協力いただきありがとうございます。</h3><p><br>本日は、課題を<strong>2つ</strong>おこないます。所要時間は合わせて5分程度です。</p><p>1つめの課題が終わった後で、休憩をすることができます。</p><p><br>任意のキーを押して、1つめの課題の説明にうつります。</p>`,
        choices: "ALL_KEYS"
    });

    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h2>課題</h2><p>これから、ドイツ語の文が<strong>2文ずつ</strong>聞こえてきます。</p><p><br>2つの文の<strong>最後の語</strong>が<strong>同じである</strong>と思ったら、 <strong>jキー</strong> を押してください。</p><p>2つの文の<strong>最後の語</strong>が<strong>異なっている</strong>と思ったら、 <strong>kキー</strong> を押してください。</p><p>直感にしたがって、できるだけ早く、正確に答えてください。</p><p><br>まず、<strong>練習</strong>を始めます。</p><p>準備ができたら、任意のキーを押して練習を開始してください。</p>`,
        choices: "ALL_KEYS"
    });
    timeline.push(...getCountdown());

    // --- Task 2 練習 (1-20の中からランダムに5ペア選択) ---
    // 1, 3, 5, ..., 19 というペアの開始番号のリストを作成
    const pracPool = [];
    for (let i = 1; i <= 20; i += 2) {
        pracPool.push(i);
    }

    // リストをシャッフルして、最初の5つ（5ペア分）だけを取り出す
    const selectedPrac = jsPsych.randomization.shuffle(pracPool).slice(0, 5);

    // 選ばれた5ペアをタイムラインに追加
    selectedPrac.forEach(i => {
        timeline.push({
            type: jsPsychAudioKeyboardResponse,
            stimulus: `../Stimuli_Task2_prac/P${String(i).padStart(2, '0')}.wav`,
            choices: "NO_KEYS",
            trial_ends_after_audio: true,
            prompt: '<div style="font-size:40px;">+</div>',
            post_trial_gap: 500
        });
        timeline.push({
            type: jsPsychAudioKeyboardResponse,
            stimulus: `../Stimuli_Task2_prac/P${String(i + 1).padStart(2, '0')}.wav`,
            choices: "NO_KEYS",
            trial_ends_after_audio: true,
            prompt: '<div style="font-size:40px;">+</div>'
        });
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>最後の語は同じでしたか？</p><p>同じ → j</p><p>違う → k</p>`,
            choices: ['j', 'k']
        });
    });

    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h3>練習は終わりです。</h3><p><br>これから、<strong>本番</strong>を始めます。</p><p>問題は18問あります。直感にしたがって、できるだけ早く、正確に答えてください。</p><p><br>準備ができたら、任意のキーを押して開始してください。</p>`,
        choices: "ALL_KEYS"
    });

    // --- Task 2 本番 ---
    const t2Pool = []; for (let i = 1; i <= 72; i += 2) { t2Pool.push(i); }
    const t2Selected = jsPsych.randomization.shuffle(t2Pool).slice(0, 18);

    timeline.push(...getCountdown());

    // (n, index) と括弧で囲む
    t2Selected.forEach((n, index) => {
        const isSame = Math.random() < 0.5;
        const s1 = `../Stimuli_TTS/S${String(n).padStart(3, '0')}.wav`;
        const s2 = isSame ? s1 : `../Stimuli_TTS/S${String(n + 1).padStart(3, '0')}.wav`;
        timeline.push({ type: jsPsychAudioKeyboardResponse, stimulus: s1, choices: "NO_KEYS", trial_ends_after_audio: true, prompt: '<div style="font-size:40px;">+</div>', post_trial_gap: 500 });
        timeline.push({ type: jsPsychAudioKeyboardResponse, stimulus: s2, choices: "NO_KEYS", trial_ends_after_audio: true, prompt: '<div style="font-size:40px;">+</div>' });
        timeline.push({
            type: jsPsychHtmlKeyboardResponse, stimulus: `<p>最後の語は同じでしたか？</p><p>同じ → j</p><p>違う → k</p>`, choices: ['j', 'k'],
            on_finish: function (data) {
                data.task = "task2test";
                data.trial_number = index + 1; // これで 1-18 が入る
                data.trial_id = n;
                data.item_type = isSame ? "same" : "different";
                data.stimulus1 = s1;
                data.stimulus2 = s2;
                data.correct = (data.response === (isSame ? 'j' : 'k'));
            }
        });
    });

    // --- Task 3 導入 ---
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h2>1つめの課題は終わりです。</h2><p><br>いま、休憩をしていただいてもかまいません。</p><p><br>準備ができたら、任意のキーを押して、2つめの課題の説明にうつります。</p>`,
        choices: "ALL_KEYS"
    });

    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h2>課題</h2><p>これから、ドイツ語の文が<strong>1文ずつ</strong>聞こえてきます。</p><p>聞こえた文が<strong>平叙文（. で終わる文）</strong>であると思ったら、 <strong>jキー</strong> を押してください。</p><p>聞こえた文が<strong>疑問文（? で終わる文）</strong>であると思ったら、 <strong>kキー</strong> を押してください。</p><p>直感にしたがって、できるだけ早く、正確に判断してください。</p><p><br>まず、<strong>練習</strong>を始めます。</p><p>準備ができたら、任意のキーを押して練習を開始してください。</p>`,
        choices: "ALL_KEYS"
    });
    timeline.push(...getCountdown());

    // --- Task 3 練習 (P21-P30の中からランダムに5問選択) ---
    const pracPool3 = [];
    for (let i = 21; i <= 30; i++) {
        pracPool3.push(i);
    }

    // 10問の中からランダムに5問を取り出す
    const selectedPrac3 = jsPsych.randomization.shuffle(pracPool3).slice(0, 5);

    selectedPrac3.forEach(i => {
        timeline.push({
            type: jsPsychAudioKeyboardResponse,
            stimulus: `../Stimuli_Task1and3_prac/P${i}.wav`,
            choices: "NO_KEYS",
            trial_ends_after_audio: true,
            prompt: '<div style="font-size:40px;">+</div>'
        });
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>文の種類は？</p><p>平叙文（.） → j</p><p>疑問文（?） → k</p>`,
            choices: ['j', 'k']
        });
    });

    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<h3>練習は終わりです。</h3><p><br>これから、<strong>本番</strong>を始めます。</p><p>問題は<strong>36問</strong>あります。直感にしたがって、できるだけ早く、正確に答えてください。</p><p><br>準備ができたら、任意のキーを押して開始してください。</p>`,
        choices: "ALL_KEYS"
    });
    timeline.push(...getCountdown());

    // --- Task 3 本番 (動的生成) ---
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "loading...", trial_duration: 500, choices: "NO_KEYS",
        on_finish: function () {
            // Task 2 本番で提示された18個の音声番号
            const t2ActualNums = jsPsych.data.get().filter({ task: 'task2test' }).values().map(d => {
                return parseInt(d.stimulus1.match(/S(\d+)/)[1]);
            });

            // 1. exposed_same: Task 2で学習した18問のうち 9問を選択
            const same_nums = jsPsych.randomization.shuffle(t2ActualNums).slice(0, 9);

            // 2. exposed_diff: Task 2で学習した残り 9問を「反転」させて使う
            const t2Remaining = t2ActualNums.filter(n => !same_nums.includes(n)); // 18 - 9 = 9問
            const diff_nums = t2Remaining.map(n => n <= 36 ? n + 36 : n - 36);

            // 3. new: Task 1で聞いたが、Task 2の本番では一度も出なかった文から 18問
            const t2BaseVoices = t2ActualNums.map(n => n <= 36 ? n : n - 36);
            const new_candidates = task1_exposed_nums.filter(n => {
                const baseN = n <= 36 ? n : n - 36;
                return !t2BaseVoices.includes(baseN);
            });
            const news = jsPsych.randomization.shuffle(new_candidates).slice(0, 18);

            // 合計 9 + 9 + 18 = 36問
            const combined = jsPsych.randomization.shuffle([
                ...same_nums.map(n => ({ n, t: "exposed_same" })),
                ...diff_nums.map(n => ({ n, t: "exposed_diff" })),
                ...news.map(n => ({ n, t: "new" }))
            ]);

            // (item, index) みたいに括弧で囲むよ。
            combined.forEach((item, index) => {
                const s1 = `Stimuli_TTS/S${String(item.n).padStart(3, '0')}.wav`;
                jsPsych.addNodeToEndOfTimeline({
                    timeline: [
                        { type: jsPsychAudioKeyboardResponse, stimulus: s1, choices: "NO_KEYS", trial_ends_after_audio: true, prompt: '<div style="font-size:40px;">+</div>' },
                        {
                            type: jsPsychHtmlKeyboardResponse, stimulus: `<p>文の種類は？</p><p>平叙文（.） → j</p><p>疑問文（?） → k</p>`, choices: ['j', 'k'],
                            on_finish: function (data) {
                                data.task = "task3test";
                                data.trial_number = index + 1; // これで 1-36 が入る
                                data.trial_id = item.n;
                                data.item_type = item.t;
                                data.stimulus1 = s1;
                                const isStmt = ((item.n >= 1 && item.n <= 36) || (item.n >= 73 && item.n <= 90));
                                data.correct = (data.response === (isStmt ? 'j' : 'k'));
                            }
                        }
                    ]
                });
            });

            // 終了画面を最後に追加
            jsPsych.addNodeToEndOfTimeline({
                timeline: [{
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<h2>全ての課題が終了しました。</h2><p>調査にご協力いただき、ありがとうございました。</p><p><br>Enterキーを押して、画面を閉じてください。</p>`,
                    choices: ["Enter"],
                    // --- Day 2の最後、jsPsych.addNodeToEndOfTimeline 内の送信部分をこれに差し替え ---
                    on_start: function () {
                        const results = jsPsych.data.get().filter([{ task: "task2test" }, { task: "task3test" }]).values();
                        // 送信先のURL
                        const save_url = "https://script.google.com/macros/s/AKfycbzCSEk6AJz2A1EV9NzwevRMXWSdKWFvkM26K2-GhFgNnIFwjUHX4UjHPh7GzVaQWMMZ/exec";

                        fetch(save_url, {
                            method: "POST",
                            mode: "no-cors", // 送るときは no-cors でOK
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(results)
                        }).then(() => {
                            console.log("Data sent successfully");
                        }).catch((err) => {
                            console.error("Data send failed", err);
                        });
                    }
                }]
            });
        }
    });

    jsPsych.run(timeline);
</script>


</html>
