<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Day 1</title>

    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">

    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
</head>

<body></body>
<script>


    //jsPsychを呼び起こす
    const jsPsych = initJsPsych({
        on_finish: function () {
            console.log("experiment finished");
        }
    });

    const timeline = [];

    //参加者IDを設定
    const subjectID = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: "配布された参加者ID（9桁）を正確に入力してください。",
                name: "subject_id",
                required: true
            }
        ],
        on_finish: function (data) {
            const id = data.response.subject_id;
            jsPsych.data.addProperties({
                subject_id: id
            });
        }
    };
    timeline.push(subjectID);


    //全体の教示
    const instruction = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
    <p>これから、調査③をおこないます。<p>
    <p>所要時間は3分程度です。</p>
    <p><strong>この調査では、パソコンから音声が流れます。</strong></p>
    <p>周囲にひとのいない、静かな環境で取り組んでください。</p>
    <p><br>Enterキーを押して、説明にうつります。</p>
    `,
        choices: ['Enter']
    };
    timeline.push(instruction);

    //-------------------Task1練習試行-----------------------
    const instructionTask1prac = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
    <h2>課題</h2>
    <p>これから、ドイツ語の文が<strong>1文ずつ</strong>聞こえてきます。</p>
    <p>聞こえた文が<strong>平叙文（. で終わる文）</strong>であると思ったら、 <strong>jキー</strong> を押してください。</p>
    <p>聞こえた文が<strong>疑問文（? で終わる文）</strong>であると思ったら、 <strong>kキー</strong> を押してください。</p>
    <p>直感にしたがって、できるだけ早く、正確に判断してください。</p>
    <p><br>まず、<strong>練習</strong>を始めます。</p>
    <p>準備ができたら、Enterキーを押して練習を開始してください。</p>
    `,
        choices: ['Enter']
    };
    timeline.push(instructionTask1prac);

    const countdown = [
        { type: jsPsychHtmlKeyboardResponse, stimulus: '<h1>3</h1>', choices: "NO_KEYS", trial_duration: 1000 },
        { type: jsPsychHtmlKeyboardResponse, stimulus: '<h1>2</h1>', choices: "NO_KEYS", trial_duration: 1000 },
        { type: jsPsychHtmlKeyboardResponse, stimulus: '<h1>1</h1>', choices: "NO_KEYS", trial_duration: 1000 }
    ];
    timeline.push(...countdown);

    const audioFilesTask1prac = [];
    for (let i = 21; i <= 30; i++) {
        audioFilesTask1prac.push(`../Stimuli_Task1and3_prac/P${String(i).padStart(2, '0')}.wav`);
    }
    const selectedPrac = jsPsych.randomization.shuffle(audioFilesTask1prac).slice(0, 5);

    selectedPrac.forEach((file, index) => {
        timeline.push({
            type: jsPsychAudioKeyboardResponse,
            stimulus: file,
            choices: "NO_KEYS",
            trial_ends_after_audio: true,
            prompt: '<div style="font-size:40px;">+</div>'
        });
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>文の種類は？</p>
            <p>平叙文（.） → j</p>
            <p>疑問文（?） → k</p>`,
            choices: ['j', 'k'],
            data: { task: "prac", trial_id: index + 1 }
        });
    });

    //----------------------Task1本試行！！----------------------------
    const instructionTask1test = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
    <h3>練習は終わりです。</h3>
    <p><br>これから、<strong>本番</strong>を始めます。</p>
    <p>問題は36問あります。直感にしたがって、できるだけ早く、正確に答えてください。</p>
    <p><br>準備ができたら、Enterキーを押して開始してください。</p>
    `,
        choices: ['Enter']
    };
    timeline.push(instructionTask1test);
    timeline.push(...countdown);


    //★↓↓↓コピペのとき，pathの../っていうのに気を付けてね！！！

    const setupTask1test = {
        type: jsPsychCallFunction,
        func: () => {
            // 届いていないファイルの除外リスト
            const missingFiles = [12, 13, 14, 15, 16, 48, 49, 50, 51, 52, 85, 86, 87, 88];

            const pool1 = []; 
            for (let i = 1; i <= 72; i++) {
                // 除外リストに含まれていない場合のみ追加
                if (!missingFiles.includes(i)) {
                    pool1.push(`../Stimuli_Human_Task1and3/S${String(i).padStart(3, '0')}.wav`);
                }
            }

            const pool2 = []; 
            for (let i = 73; i <= 108; i++) {
                // 除外リストに含まれていない場合のみ追加
                if (!missingFiles.includes(i)) {
                    pool2.push(`../Stimuli_Human_Task1and3/S${String(i).padStart(3, '0')}.wav`);
                }
            }

            // シャッフルして各プールから18個ずつ選択
            // ※もしプールの残数が18個未満になってもエラーにならないよう shuffle().slice() を使用
            window.day1Stimuli = jsPsych.randomization.shuffle([
                ...jsPsych.randomization.shuffle(pool1).slice(0, 18).map(s => ({ stim: s })),
                ...jsPsych.randomization.shuffle(pool2).slice(0, 18).map(s => ({ stim: s }))
            ]);
        }
    };

    //★↑↑↑

    timeline.push(setupTask1test);

    let testTrialCounter = 0;

    const task1_procedure = {
        timeline: [
            {
                type: jsPsychAudioKeyboardResponse,
                stimulus: jsPsych.timelineVariable('stim'),
                choices: "NO_KEYS",
                trial_ends_after_audio: true,
                prompt: '<div style="font-size:40px;">+</div>'
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p>文の種類は？</p>
                <p>平叙文（.） → j</p>
                <p>疑問文（?） → k</p>`,
                choices: ['j', 'k'],
                on_finish: function (data) {
                    const currentStim = String(jsPsych.timelineVariable('stim'));//evaluateTimeline...みたいな書き方は，最新ver.のjsPsychでは通じないらしい。
                    data.task = "task1test";
                    data.stimulus = currentStim;

                    // --- ここで専用の試行番号を作成 ---
                    testTrialCounter++; // 1問ごとに+1する
                    data.test_index = testTrialCounter; // dataに保存

                    const numMatch = currentStim.match(/S(\d+)/);
                    if (numMatch) {
                        const num = parseInt(numMatch[1], 10);
                        data.trial_id = num;
                        let correctAnswer = ((num >= 1 && num <= 36) || (num >= 73 && num <= 90)) ? 'j' : 'k';
                        data.correct_answer = correctAnswer;
                        data.correct = (data.response === correctAnswer);
                    }
                }
            }
        ],
        timeline_variables: Array.from({ length: 36 }),
        on_timeline_start: function () {
            this.timeline_variables = window.day1Stimuli;
        }
    };

    timeline.push(task1_procedure);

    const Task1owaridayo = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
    <h2>本日の調査は終わりです。</h2>
    <p><br>後日、続きの調査（所要時間5分）のURLをお送りしますので、引き続きご協力のほどよろしくお願い申し上げます。</p>
    <p><strong>参加者IDは後日も使用するので、必ず記録したままにしておいてください。</strong></p>
    <p><br>ご協力ありがとうございました。Enterキーを押して、画面を閉じてください。</p>
    `,
        choices: ['Enter'],
        on_start: function () { saveData(); }
    };
    timeline.push(Task1owaridayo);

    jsPsych.run(timeline);

    function saveData() {
        const rawData = jsPsych.data.get().filter({ task: "task1test" }).values();

        const cleanData = rawData.map(trial => {
            return {
                subject_id: trial.subject_id,
                trial_index: trial.test_index,
                trial_id: trial.trial_id,
                task: trial.task,
                stimulus: trial.stimulus,
                response: trial.response,
                correct_answer: trial.correct_answer,
                correct: trial.correct,
                rt: trial.rt
            };
        });

        fetch("https://script.google.com/macros/s/AKfycbxb7RzSbAA86WT85BPWjN5USyPV7FB3xb7h4pJVZ8iAEBI3py5lBzgJiG3c3FPtQzlF/exec", {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cleanData)
        });
    }
</script>

</html>
